const http = require('http');

function getConsulHost() {
  const host = process.env.HOST_IP_ADDR
  || process.env.CONSUL_HTTP_HOST
  || process.env.TCE_HOST_IP
  || '127.0.0.1';
  return host;
}

function getConsultPort() {
  const port = process.env.CONSUL_HTTP_PORT || 2280;
  return port;
}

function getConsulUrl(psm = 'toutiao.tos.tosapi', host = getConsulHost(), port = getConsultPort()) {
  return `http://${host}:${port}/v1/lookup/name?name=${encodeURIComponent(psm)}`;
}

function getServerRandomly(servers, cluster) {
  const valid = servers.filter(server => server.Tags && server.Tags.cluster === cluster);
  const len = valid.length;
  const rand = Math.floor(Math.random() * len);
  return valid[rand] || {};
}

function consul(cluster, psm) {
  return new Promise((resolve, reject) => {
    http.get(getConsulUrl(psm), res => {
      const { statusCode } = res;
      if (statusCode !== 200) {
        reject(`consul: ${statusCode}`);
        res.resume();
        return;
      }

      res.setEncoding('utf8');
      let rawData = '', parsedData;
      res.on('data', chunk => rawData += chunk);
      res.on('end', () => {
        try {
          parsedData = JSON.parse(rawData);

          const server = getServerRandomly(parsedData, cluster);
          resolve({ host: server.Host || '', port: server.Port || 0 });
        } catch (e) {
          reject(e);
        }
      });

    }).on('error', err => {
      reject(err);
    })
  })
}

exports.consul = consul;

